import{DeleteCommand as b,GetCommand as N,PutCommand as A,ScanCommand as S,UpdateCommand as C}from"@aws-sdk/lib-dynamodb";import{DynamoDBClient as E}from"@aws-sdk/client-dynamodb";import{DynamoDBDocumentClient as h}from"@aws-sdk/lib-dynamodb";var g=process.env.INVESTMENT_TABLE_NAME;if(!g)throw new Error("INVESTMENT_TABLE_NAME environment variable is not defined.");var x=new E({region:process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION||"us-east-1",...process.env.DYNAMODB_ENDPOINT?{endpoint:process.env.DYNAMODB_ENDPOINT}:{}}),d=h.from(x,{marshallOptions:{removeUndefinedValues:!0}}),c=g;var R=new Set(["id","price"]),T=(t,e)=>{if(!(e==null||e==="")){if(R.has(t)){let n=Number(e);return Number.isNaN(n)?void 0:n}return t==="year"?String(e):e}},k=(t={})=>{let e={};for(let[n,r]of Object.entries(t)){let s=T(n,r);s!==void 0&&(e[n]=s)}return e},O=(t={})=>{let e=[],n={},r={};for(let[s,a]of Object.entries(t)){if(a==null||a==="")continue;let o=`#${s}`,i=`:${s}`;n[o]=s,r[i]=a,e.push(`${o} = ${i}`)}return e.length?{FilterExpression:e.join(" AND "),ExpressionAttributeNames:n,ExpressionAttributeValues:r}:{}},F=async t=>{let e=[],n;do{let r=new S({...t,ExclusiveStartKey:n}),{Items:s=[],LastEvaluatedKey:a}=await d.send(r);e.push(...s),n=a}while(n);return e},D=(t="")=>t.split(",").map(e=>e.trim()).filter(Boolean).map(e=>({field:e.replace(/^[-+]/,""),direction:e.startsWith("-")?-1:1})).filter(({field:e})=>!!e),_=(t,e)=>t===e?0:t==null?1:e==null?-1:typeof t=="string"&&typeof e=="string"?t.localeCompare(e):t>e?1:-1,B=(t,e="")=>{let n=D(e);if(!n.length)return t;let r=[...t];return r.sort((s,a)=>{for(let{field:o,direction:i}of n){let u=_(s?.[o],a?.[o]);if(u!==0)return u*i}return 0}),r},m={async getById(t){let{Item:e}=await d.send(new N({TableName:c,Key:{id:t}}));return e??null},async list({filters:t={},sortBy:e}={}){let n=k(t),r={TableName:c,...O(n)},s=await F(r);return B(s,e||"")},async create(t){return await d.send(new A({TableName:c,Item:t,ConditionExpression:"attribute_not_exists(#id)",ExpressionAttributeNames:{"#id":"id"}})),t},async update(t,e){let n=Object.entries(e).filter(([,o])=>o!==void 0);if(!n.length)return null;let r=[],s={"#id":"id"},a={};n.forEach(([o,i],u)=>{let p=`#field_${u}`,I=`:value_${u}`;s[p]=o,a[I]=i,r.push(`${p} = ${I}`)});try{let{Attributes:o}=await d.send(new C({TableName:c,Key:{id:t},UpdateExpression:`SET ${r.join(", ")}`,ExpressionAttributeNames:s,ExpressionAttributeValues:a,ConditionExpression:"attribute_exists(#id)",ReturnValues:"ALL_NEW"}));return o??null}catch(o){if(o.name==="ConditionalCheckFailedException")return null;throw o}},async delete(t){let{Attributes:e}=await d.send(new b({TableName:c,Key:{id:t},ReturnValues:"ALL_OLD"}));return e??null}};var G=new Set(["id","price"]),f=t=>{if(!t)return null;if(typeof t=="object")return t;try{return JSON.parse(t)}catch(e){return console.error("Failed to parse request body:",e),null}},w=(t={})=>{let e={};for(let[n,r]of Object.entries(t))if(r!=null){if(G.has(n)){let s=Number(r);Number.isNaN(s)||(e[n]=s);continue}if(n==="year"){e.year=r.toString();continue}e[n]=r}return e},P=t=>{let e=t.match(/^\/investment\/(\d+)$/);return e?Number(e[1]):null},v=()=>{let t=Date.now().toString(),e=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return+`${t}${e}`};var y={async getById(t){return await m.getById(t)},async list({queryParams:t={}}={}){let{sort_by:e,...n}=t;return await m.list({filters:n,sortBy:e})},async create(t){let e=f(t);if(!e)throw new Error("Invalid request body");let n=w(e);n.id===void 0&&(n.id=v()),n.createdAt||(n.createdAt=new Date().toISOString());try{return await m.create(n)}catch(r){if(r.name==="ConditionalCheckFailedException"){let s=new Error("Investment ID already exists");throw s.statusCode=409,s}throw r}},async update(t,e){let n=P(t);if(n===null)throw new Error("Invalid PUT Path");let r=f(e);if(!r)throw new Error("Invalid request body");let s=w(r);if(!Object.keys(s).length)throw new Error("No valid fields provided for update");let a=await m.update(n,s);if(!a){let o=new Error("Investment Not Found");throw o.statusCode=404,o}return a},async delete(t){let e=P(t);if(e===null)throw new Error("Invalid DELETE Path");let n=await m.delete(e);if(!n){let r=new Error("Investment Not Found");throw r.statusCode=404,r}return n}};var l=(t,e,n,r=null,s=null)=>({statusCode:e,body:JSON.stringify({status:t,message:n,data:r,error:s}),headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,GET,OPTIONS,DELETE,PUT,PATCH","Access-Control-Allow-Headers":"Content-Type,X-CSRF-TOKEN"}});var ne=async(t,e)=>{let{httpMethod:n,path:r,body:s,queryStringParameters:a}=t;try{switch(n){case"GET":return await K(t);case"POST":return await M(s);case"PUT":return await L(r,s);case"DELETE":return await V(r);default:return l("1",405,"Method Not Allowed",null,null)}}catch(o){console.error("Handler Error:",o);let i=o,u=i.statusCode||500,p=i.message||"Internal Server Error";return l("1",u,p,null,{message:i.message})}},K=async t=>{let{path:e,queryStringParameters:n}=t,r=$(e||"");if(r!==null){let a=await y.getById(r);return a?l("0",200,"OK",a,null):l("1",404,"Investment Not Found",null,null)}let s=await y.list({queryParams:n||{}});return l("0",200,"OK",s,null)},M=async t=>{let e=await y.create(t);return l("0",201,"OK",e,null)},L=async(t,e)=>{let n=await y.update(t,e);return l("0",200,"OK",n,null)},V=async t=>(await y.delete(t),l("0",204,"OK",null,null)),$=t=>{let e=t.match(/^\/investment\/(\d+)$/);return e?Number(e[1]):null};export{ne as lambdaHandler};
//# sourceMappingURL=investment.js.map
